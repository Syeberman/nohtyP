version: 0.5.{build}

branches:
  only:
    - main

skip_branch_with_pr: true

cache: Build/site_toolsconfig.py

deploy: off

image:
  - Visual Studio 2019
  - Ubuntu2004
  # - Visual Studio 2017
  # - Ubuntu1604
  # - Visual Studio 2015

platform:
  - x64
  - x86

configuration:
  - Debug
  - Build

# Ideally, each compiler is listed once, against the most-recent image that includes it.
for:
  # TODO: Support Visual Studio 2019: YP_COMPILER_OS: msvs_160_win32
  - matrix:
      only:
        - image: Visual Studio 2019
    environment:
      YP_COMPILER_OS: gcc_9_win32
  - matrix:
      only:
        - image: Visual Studio 2019
    environment:
      YP_COMPILER_OS: gcc_8_win32
  - matrix:
      only:
        - image: Ubuntu2004
    environment:
      YP_COMPILER_OS: gcc_9_posix
  - matrix:
      only:
        - image: Ubuntu2004
    environment:
      YP_COMPILER_OS: gcc_8_posix
  - matrix:
      only:
        - image: Ubuntu2004
    environment:
      YP_COMPILER_OS: gcc_7_posix

install:
  # Write out a Build/.appveyor.ps1 file containing common configurations.
  - pwsh: |
      echo @'
      if ($isWindows) { $env:Path = "C:/Python38-x64;$($env:Path)" }
      if ($isLinux) { . $HOME/venv3.8/bin/activate.ps1 }
      if (! $env:YP_COMPILER_OS) { throw "YP_COMPILER_OS not set" }
      switch ($env:PLATFORM) {
        "x64" { $env:YP_ARCH = "amd64" }
        "x86" { $env:YP_ARCH = "x86" }
        default { throw "unknown platform $($env:PLATFORM)" }
      }
      switch ($env:CONFIGURATION) {
        "Debug" { $env:YP_CONFIGURATION = "debug" }
        "Build" { $env:YP_CONFIGURATION = "release" }
        default { throw "unknown configuration $($env:CONFIGURATION)" }
      }
      $env:YP_BUILD_TARGET = "$($env:YP_COMPILER_OS)_$($env:YP_ARCH)_$($env:YP_CONFIGURATION)"
      '@ > Build/.appveyor.ps1

build_script:
  - pwsh: |
      . Build/.appveyor.ps1
      echo "Building $($env:YP_BUILD_TARGET)"
      Build/make $env:YP_BUILD_TARGET
      if (! $?) { throw "build failed" }

test_script:
  - pwsh: |
      . Build/.appveyor.ps1
      echo "Testing $($env:YP_BUILD_TARGET)"
      Build/make "test$($env:YP_BUILD_TARGET)"
      if (! $?) {
        7z a yp_test.log.zip Build/*/*/yp_test.log
        appveyor PushArtifact yp_test.log.zip
        throw "build failed"
      }
